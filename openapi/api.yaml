---

openapi: 3.0.1

info:
  title: Image Storage API
  version: "1.0.0"
  description: >
    Image storage service providing upload, listing, retrieval,
    and deletion of images using AWS API Gateway, Lambda, S3,
    and DynamoDB.
  contact:
    name: API Support
    email: bkumar28@gmail.com
    url: https://github.com/bharatkse/image-storage-service
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:4566/restapis/{api_id}/{stage}/_user_request_
    description: LocalStack API Gateway (REST API)
    variables:
      api_id:
        default: xxxxxxxxxx
        description: API Gateway ID from CloudFormation outputs
      stage:
        default: snd
        description: Environment stage (snd, dev, uat, prod)

  - url: https://{api_id}.execute-api.{region}.amazonaws.com/{stage}
    description: AWS API Gateway
    variables:
      api_id:
        default: xxxxxxxxxx
      region:
        default: us-east-1
      stage:
        default: prod

security:
  - ApiKeyAuth: []

tags:
  - name: Images
    description: Image storage and management operations

paths:
  /v1/images:
    post:
      summary: Upload a new image with metadata
      description: Upload an image to S3 and persist metadata in DynamoDB.
      operationId: uploadImage
      tags:
        - Images
      security:
        - ApiKeyAuth: []

      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ImageUploadRequest"
            examples:
              sample:
                value:
                  user_id: "user123"
                  image_name: "vacation-photo.jpg"
                  description: "Summer vacation at the beach"
                  tags: ["vacation", "beach"]
                  file: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJ..."

      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: "arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/arn:aws:lambda:us-east-1:000000000000:function:image-storage-upload-image-snd/invocations"
        responses:
          default:
            statusCode: "200"
      responses:
        "201":
          description: Image uploaded successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImageUploadResponse"
              examples:
                success:
                  value:
                    image_id: "img_a1b2c3d4e5f6"
                    user_id: "user123"
                    image_name: "vacation-photo.jpg"
                    description: "Summer vacation at the beach"
                    created_at: "2024-01-15T10:30:00Z"
                    s3_key: "users/user123/img_a1b2c3d4e5f6.jpg"
                    file_size: 245678
                    mime_type: "image/jpeg"
                    message: "Image uploaded successfully"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Duplicate image detected
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "DuplicateImageError"
                message: "This image already exists (file hash match)"
                timestamp: "2024-01-15T10:30:00Z"
                existing_image_id: "img_previous123"
        "413":
          $ref: "#/components/responses/PayloadTooLarge"
        "415":
          description: Unsupported media type
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

    get:
      summary: List stored images
      description: >
        Supports:
        - Name substring filter (in-memory)
        - Date range filter (DynamoDB-level)
      operationId: listImages
      tags:
        - Images
      security:
        - ApiKeyAuth: []
      parameters:
        - name: user_id
          in: query
          required: true
          description: User identifier to filter images
          schema:
            type: string
            minLength: 3
            maxLength: 50
            pattern: "^[a-zA-Z0-9_-]+$"
          example: "user123"

        - name: name_contains
          in: query
          required: false
          description: Filter images by name substring (case-insensitive)
          schema:
            type: string
            minLength: 1
            maxLength: 100
          example: "vacation"

        - name: start_date
          in: query
          required: false
          description: Filter images created on or after this date (ISO 8601 format YYYY-MM-DD)
          schema:
            type: string
            format: date
          example: "2024-01-01"

        - name: end_date
          in: query
          required: false
          description: Filter images created on or before this date (ISO 8601 format YYYY-MM-DD)
          schema:
            type: string
            format: date
          example: "2024-01-31"

        - name: limit
          in: query
          required: false
          description: Maximum number of results to return (1-100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20

        - name: offset
          in: query
          required: false
          description: Number of results to skip for pagination
          schema:
            type: integer
            minimum: 0
            default: 0
          example: 0

        - name: sort_by
          in: query
          required: false
          description: Field to sort results by
          schema:
            type: string
            enum:
              - created_at
              - image_name
            default: created_at
          example: "created_at"

        - name: sort_order
          in: query
          required: false
          description: Sort order (ascending or descending)
          schema:
            type: string
            enum:
              - asc
              - desc
            default: desc
          example: "desc"

      x-amazon-apigateway-request-validator: params-only
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/arn:aws:lambda:us-east-1:000000000000:function:image-storage-list-images-snd/invocations
      responses:
        "200":
          description: Images retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListImagesResponse"
              examples:
                withResults:
                  value:
                    images:
                      - image_id: "img_a1b2c3d4"
                        user_id: "user123"
                        image_name: "vacation-beach.jpg"
                        description: "Beach photo"
                        tags: ["vacation", "beach"]
                        created_at: "2024-01-15T10:30:00Z"
                        s3_key: "users/user123/img_a1b2c3d4.jpg"
                        file_size: 245678
                        mime_type: "image/jpeg"
                      - image_id: "img_x9y8z7w6"
                        user_id: "user123"
                        image_name: "vacation-sunset.jpg"
                        created_at: "2024-01-14T18:45:00Z"
                        s3_key: "users/user123/img_x9y8z7w6.jpg"
                        file_size: 187234
                        mime_type: "image/jpeg"
                    total_count: 2
                    returned_count: 2
                    filter_applied: "name_contains: vacation"
                    pagination:
                      limit: 20
                      offset: 0
                      has_more: false
                empty:
                  value:
                    images: []
                    total_count: 0
                    returned_count: 0
                    filter_applied: null
                    pagination:
                      limit: 20
                      offset: 0
                      has_more: false
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /v1/images/{image_id}:
    get:
      summary: Retrieve a stored image
      description: Download image binary from S3.
      operationId: getImage
      tags:
        - Images
      security:
        - ApiKeyAuth: []
      parameters:
        - name: image_id
          in: path
          required: true
          description: Unique image identifier
          schema:
            type: string
            minLength: 1
            pattern: "^img_[a-zA-Z0-9]+$"
          example: "img_a1b2c3d4e5f6"

        - name: metadata
          in: query
          required: false
          description: Include metadata in response header (X-Image-Metadata)
          schema:
            type: boolean
            default: false
          example: true

      x-amazon-apigateway-request-validator: params-only
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/arn:aws:lambda:us-east-1:000000000000:function:image-storage-get-image-snd/invocations
      responses:
        "200":
          description: Image retrieved successfully
          headers:
            Content-Type:
              description: Image MIME type
              schema:
                type: string
              example: "image/jpeg"
            Content-Length:
              description: File size in bytes
              schema:
                type: integer
              example: 245678
            X-Image-Metadata:
              description: Image metadata JSON (when metadata=true)
              schema:
                $ref: "#/components/schemas/ImageMetadataHeader"
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
            image/png:
              schema:
                type: string
                format: binary
            image/gif:
              schema:
                type: string
                format: binary
            image/webp:
              schema:
                type: string
                format: binary
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      summary: Delete a stored image
      description: Permanently delete image and metadata.
      operationId: deleteImage
      tags:
        - Images
      security:
        - ApiKeyAuth: []
      parameters:
        - name: image_id
          in: path
          required: true
          description: Unique image identifier
          schema:
            type: string
            minLength: 1
            pattern: "^img_[a-zA-Z0-9]+$"
          example: "img_a1b2c3d4e5f6"

      x-amazon-apigateway-request-validator: params-only
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri: arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/arn:aws:lambda:us-east-1:000000000000:function:image-storage-delete-image-snd/invocations
      responses:
        "200":
          description: Image deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteImageResponse"
              example:
                image_id: "img_a1b2c3d4e5f6"
                message: "Image deleted successfully"
                deleted_at: "2024-01-15T11:00:00Z"
                s3_key: "users/user123/img_a1b2c3d4e5f6.jpg"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

x-amazon-apigateway-request-validators:
  all:
    validateRequestBody: true
    validateRequestParameters: true
  params-only:
    validateRequestBody: false
    validateRequestParameters: true

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
      description: |
        API key for authentication. Include in all requests via the `x-api-key` header.

  schemas:
    ImageMetadataHeader:
      type: string
      description: >
        Base64-encoded JSON string containing image metadata.
        Returned only when `metadata=true` query parameter is used.
      example: >
        eyJpbWFnZV9pZCI6ICJpbWdfYTFiMmMzZDRlNWY2IiwgInVzZXJfaWQiOiAidXNlcjEyMyIsICJpbWFnZV9uYW1lIjogInZhY2F0aW9uLXBob3RvLmpwZyIsICJjcmVhdGVkX2F0IjogIjIwMjQtMDEtMTVUMTA6MzA6MDBaIiwgIm1pbWVfdHlwZSI6ICJpbWFnZS9qcGVnIn0=

    ImageUploadRequest:
      type: object
      required:
        - file
        - user_id
        - image_name
      properties:
        file:
          type: string
          description: Base64 encoded image file
          format: byte
          example: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
        user_id:
          type: string
          description: User identifier (alphanumeric, hyphens, underscores)
          minLength: 3
          maxLength: 50
          pattern: "^[a-zA-Z0-9_-]+$"
          example: "user123"
        image_name:
          type: string
          description: Image filename with extension
          minLength: 1
          maxLength: 255
          example: "vacation-photo.jpg"
        description:
          type: string
          description: Optional image description
          maxLength: 1000
          nullable: true
          example: "Summer vacation at the beach"
        tags:
          type: array
          description: Optional tags for categorization
          items:
            type: string
            minLength: 1
            maxLength: 50
          maxItems: 10
          nullable: true
          example: ["vacation", "beach", "summer", "2024"]

    ImageUploadResponse:
      type: object
      required:
        - image_id
        - user_id
        - image_name
        - created_at
        - s3_key
        - file_size
        - mime_type
        - message
      properties:
        image_id:
          type: string
          description: Unique image identifier
          example: "img_a1b2c3d4e5f6"
        user_id:
          type: string
          example: "user123"
        image_name:
          type: string
          example: "vacation-photo.jpg"
        description:
          type: string
          nullable: true
          example: "Summer vacation at the beach"
        tags:
          type: array
          items:
            type: string
          nullable: true
          example: ["vacation", "beach"]
        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp
          example: "2024-01-15T10:30:00Z"
        s3_key:
          type: string
          description: S3 object key
          example: "users/user123/img_a1b2c3d4e5f6.jpg"
        file_size:
          type: integer
          description: File size in bytes
          example: 245678
        mime_type:
          type: string
          description: Image MIME type
          example: "image/jpeg"
        file_hash:
          type: string
          description: SHA-256 hash of file content
          nullable: true
          example: "a1b2c3d4e5f6..."
        message:
          type: string
          example: "Image uploaded successfully"

    ImageMetadata:
      type: object
      required:
        - image_id
        - user_id
        - image_name
        - created_at
        - s3_key
        - file_size
        - mime_type
      properties:
        image_id:
          type: string
          example: "img_a1b2c3d4e5f6"
        user_id:
          type: string
          example: "user123"
        image_name:
          type: string
          example: "vacation-photo.jpg"
        description:
          type: string
          nullable: true
          example: "Summer vacation"
        tags:
          type: array
          items:
            type: string
          nullable: true
          example: ["vacation", "beach"]
        created_at:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          nullable: true
          example: "2024-01-15T10:30:00Z"
        s3_key:
          type: string
          example: "users/user123/img_a1b2c3d4e5f6.jpg"
        file_size:
          type: integer
          example: 245678
        mime_type:
          type: string
          example: "image/jpeg"
        file_hash:
          type: string
          nullable: true
          example: "sha256:a1b2c3d4..."

    ListImagesResponse:
      type: object
      required:
        - images
        - total_count
        - returned_count
      properties:
        images:
          type: array
          description: Array of image metadata objects
          items:
            $ref: "#/components/schemas/ImageMetadata"
        total_count:
          type: integer
          description: Total number of images matching filter
          example: 42
        returned_count:
          type: integer
          description: Number of images in this response
          example: 20
        filter_applied:
          type: string
          nullable: true
          description: Description of applied filters
          example: "name_contains: vacation, date_range: 2024-01-01 to 2024-01-31"
        pagination:
          type: object
          required:
            - limit
            - offset
            - has_more
          properties:
            limit:
              type: integer
              example: 20
            offset:
              type: integer
              example: 0
            has_more:
              type: boolean
              description: Whether more results are available
              example: true
            next_offset:
              type: integer
              description: Offset for next page
              example: 20

    DeleteImageResponse:
      type: object
      required:
        - image_id
        - message
        - deleted_at
        - s3_key
      properties:
        image_id:
          type: string
          example: "img_a1b2c3d4e5f6"
        message:
          type: string
          example: "Image deleted successfully"
        deleted_at:
          type: string
          format: date-time
          example: "2024-01-15T11:00:00Z"
        s3_key:
          type: string
          example: "users/user123/img_a1b2c3d4e5f6.jpg"

    ErrorResponse:
      type: object
      required:
        - error
        - message
        - timestamp
      properties:
        error:
          type: string
          description: Error type/code
          example: "ValidationError"
        message:
          type: string
          description: Human-readable error message
          example: "Invalid image format. Supported formats: JPEG, PNG, GIF, WebP"
        timestamp:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"
        request_id:
          type: string
          description: Request ID for debugging
          example: "req_xyz123"
        details:
          type: object
          description: Additional error details
          nullable: true
          additionalProperties: true

  responses:
    BadRequest:
      description: Invalid request parameters or body
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            validationError:
              value:
                error: "ValidationError"
                message: "Missing required field: user_id"
                timestamp: "2024-01-15T10:30:00Z"
                request_id: "req_abc123"
            invalidFormat:
              value:
                error: "InvalidImageFormat"
                message: "Unsupported image format. Supported: JPEG, PNG, GIF, WebP"
                timestamp: "2024-01-15T10:30:00Z"

    Unauthorized:
      description: Missing or invalid API key
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "Unauthorized"
            message: "Missing or invalid API key"
            timestamp: "2024-01-15T10:30:00Z"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "NotFound"
            message: "Image not found"
            timestamp: "2024-01-15T10:30:00Z"

    TooManyRequests:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "RateLimitExceeded"
            message: "Rate limit exceeded. Try again later."
            timestamp: "2024-01-15T10:30:00Z"
            details:
              limit: 50
              period: "second"

    PayloadTooLarge:
      description: Image file exceeds maximum size
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "PayloadTooLarge"
            message: "Image exceeds maximum size of 10MB"
            timestamp: "2024-01-15T10:30:00Z"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "InternalServerError"
            message: "An unexpected error occurred"
            timestamp: "2024-01-15T10:30:00Z"
            request_id: "req_xyz789"
